{% extends 'base.html' %}
{% load static %}

{% block title %}Session {{ session.session_id }} - {{ session.patient.name }}{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.css">
<script src="{% static 'js/reconnecting-websocket.js' %}"></script>
<style>
    .status-badge {
        font-size: 1rem;
        padding: 0.5rem 1rem;
        border-radius: 20px;
    }
    .card {
        border: none;
        box-shadow: 0 0.125rem 0.25rem rgba(0,0,0,0.075);
        margin-bottom: 1.5rem;
        border-radius: 0.5rem;
    }
    .card-header {
        background-color: #f8f9fa;
        border-bottom: 1px solid rgba(0,0,0,.125);
        padding: 1rem 1.25rem;
        border-top-left-radius: 0.5rem !important;
        border-top-right-radius: 0.5rem !important;
    }
    .card-title {
        font-weight: 600;
        color: #343a40;
        margin: 0;
    }
    .info-card {
        border-left: 4px solid #4e73df;
        transition: transform 0.2s;
    }
    .info-card:hover {
        transform: translateY(-2px);
    }
    .info-label {
        font-weight: 500;
        color: #6c757d;
    }
    .info-value {
        font-weight: 600;
        color: #343a40;
    }
    .data-table {
        font-size: 0.9rem;
    }
    .data-table th {
        background-color: #f8f9fa;
        font-weight: 600;
    }
</style>
{% endblock %}

{% block page_title %}
  <div class="d-flex justify-content-between align-items-center">
    <div>
      <h1 class="h3 mb-0 text-gray-800">Session Details</h1>
      <p class="mb-0 text-muted">{{ session.patient.name }} | {{ session.created_at|date:"M d, Y H:i" }}</p>
    </div>
    <span class="badge status-badge bg-{% if session.status == 'completed' %}success{% elif session.status == 'failed' %}danger{% else %}warning{% endif %}">
      <i class="fas fa-{% if session.status == 'completed' %}check-circle{% elif session.status == 'failed' %}times-circle{% else %}hourglass-half{% endif %} me-1"></i>
      {{ session.get_status_display }}
    </span>
  </div>
{% endblock %}

{% block breadcrumb %}
  <nav aria-label="breadcrumb">
    <ol class="breadcrumb">
      <li class="breadcrumb-item"><a href="{% url 'patients:patient_list' %}">Patients</a></li>
      <li class="breadcrumb-item"><a href="{% url 'patients:patient_detail' session.patient.pk %}">{{ session.patient.name }}</a></li>
      <li class="breadcrumb-item active" aria-current="page">Session {{ session.session_id|truncatechars:12 }}</li>
    </ol>
  </nav>
{% endblock %}

{% block content %}
<div class="row">
  <div class="col-lg-4">
    <!-- Session Information Card -->
    <div class="card info-card mb-4">
      <div class="card-header">
        <h5 class="card-title mb-0"><i class="fas fa-info-circle me-2"></i>Session Information</h5>
      </div>
      <div class="card-body">
        <div class="mb-3">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <span class="info-label"><i class="fas fa-user me-2"></i>Patient</span>
            <a href="{% url 'patients:patient_detail' session.patient.pk %}" class="text-primary text-decoration-none">
              {{ session.patient.name }}
            </a>
          </div>
          
          <div class="d-flex justify-content-between align-items-center mb-2">
            <span class="info-label"><i class="fas fa-id-card me-2"></i>Patient ID</span>
            <span class="info-value">{{ session.patient.patient_id|default:'N/A' }}</span>
          </div>
          
          <div class="d-flex justify-content-between align-items-start mb-2">
            <span class="info-label"><i class="fas fa-fingerprint me-2"></i>Session ID</span>
            <span class="info-value text-end" style="max-width: 60%; word-break: break-all;" data-toggle="tooltip" title="{{ session.session_id }}">
              {{ session.session_id }}
            </span>
          </div>
          
          <div class="d-flex justify-content-between align-items-center mb-2">
            <span class="info-label"><i class="fas fa-microchip me-2"></i>Device ID</span>
            <span class="info-value">{{ session.device_id|default:'N/A' }}</span>
          </div>
          
          <div class="d-flex justify-content-between align-items-center mb-2">
            <span class="info-label"><i class="far fa-calendar-plus me-2"></i>Created</span>
            <span class="info-value" title="{{ session.created_at|date:'DATETIME_FORMAT' }}">
              {{ session.created_at|timesince }} ago
            </span>
          </div>
          
          {% if session.status == 'completed' %}
          <div class="d-flex justify-content-between align-items-center mb-2">
            <span class="info-label"><i class="far fa-calendar-check me-2"></i>Completed</span>
            <span class="info-value" title="{{ session.updated_at|date:'DATETIME_FORMAT' }}">
              {{ session.updated_at|timesince }} ago
            </span>
          </div>
          {% endif %}
          
          <div class="d-flex justify-content-between align-items-center mb-3">
            <span class="info-label"><i class="fas fa-database me-2"></i>Data Points</span>
            <span class="badge bg-primary rounded-pill data-points-count">{{ session.spectra.count }}</span>
          </div>
          
          <form method="post" onsubmit="return confirm('Are you sure you want to delete this session? This action cannot be undone.');">
            {% csrf_token %}
            <button type="submit" name="delete_session" class="btn btn-danger w-100">
              <i class="fas fa-trash me-2"></i>Delete Session
            </button>
          </form>
        </div>
      </div>
    </div>
    
    <!-- Analysis Card -->
    <div class="card">
      <div class="card-header">
        <h5 class="card-title mb-0"><i class="fas fa-chart-bar me-2"></i>Analysis</h5>
      </div>
      <div class="card-body">
        <div class="row text-center">
          <div class="col-6 mb-3">
            <div class="p-3 border rounded">
              <div class="text-muted small">PEAK</div>
              <div class="h5 font-weight-bold">-</div>
            </div>
          </div>
          <div class="col-6 mb-3">
            <div class="p-3 border rounded">
              <div class="text-muted small">FWHM</div>
              <div class="h5 font-weight-bold">-</div>
            </div>
          </div>
        </div>
        <div class="text-center">
          <button class="btn btn-outline-primary btn-sm">
            <i class="fas fa-chart-line me-1"></i>Full Analysis
          </button>
        </div>
      </div>
    </div>
  </div>
  
  <div class="col-lg-8">
    <!-- Chart Section -->
    <div class="card mb-4">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0"><i class="fas fa-chart-line me-2"></i>Spectral Data</h5>
        <div>
          <button class="btn btn-sm btn-outline-secondary reset-zoom me-2">
            <i class="fas fa-sync-alt me-1"></i>Reset Zoom
          </button>
          <button id="downloadPNG" class="btn btn-sm btn-outline-primary">
            <i class="fas fa-download me-1"></i>Download PNG
          </button>
        </div>
      </div>
      <div class="card-body">
        <div class="chart-area">
          <canvas id="spectralChart" height="300"></canvas>
        </div>
      </div>
      <div class="card-footer bg-white">
        <div class="row">
          <div class="col-md-4">
            <div class="input-group input-group-sm">
              <span class="input-group-text">Min</span>
              <input type="number" class="form-control" id="minWavelength" placeholder="Min wavelength">
              <span class="input-group-text">nm</span>
            </div>
          </div>
          <div class="col-md-4">
            <div class="input-group input-group-sm">
              <span class="input-group-text">Max</span>
              <input type="number" class="form-control" id="maxWavelength" placeholder="Max wavelength">
              <span class="input-group-text">nm</span>
            </div>
          </div>
          <div class="col-md-4">
            <button id="applyRange" class="btn btn-sm btn-primary w-100">
              <i class="fas fa-filter me-1"></i>Apply Range
            </button>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Data Table Section -->
    <div class="card">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0"><i class="fas fa-table me-2"></i>Data Points</h5>
        <div>
          <a href="{% url 'patients:export_csv' session.session_id %}" class="btn btn-sm btn-outline-primary me-2">
            <i class="fas fa-file-csv me-1"></i>Export CSV
          </a>
          <button type="button" class="btn btn-sm btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#dataModal">
            <i class="fas fa-expand me-1"></i>View Full Screen
          </button>
        </div>
      </div>
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-striped table-bordered data-table" style="width:100%">
            <thead>
              <tr>
                <th>Wavelength (nm)</th>
                <th>Intensity</th>
                <th>Timestamp</th>
              </tr>
            </thead>
            <tbody>
              {% for point in session.spectra.all|slice:":10" %}
              <tr>
                <td>{{ point.wavelength|floatformat:2 }}</td>
                <td>{{ point.intensity|floatformat:4 }}</td>
                <td>{{ point.timestamp|date:"Y-m-d H:i:s" }}</td>
              </tr>
              {% empty %}
              <tr>
                <td colspan="3" class="text-center">No data points available</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Data Modal -->
<div class="modal fade" id="dataModal" tabindex="-1" aria-labelledby="dataModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="dataModalLabel">Session Data - {{ session.session_id }}</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="table-responsive">
          <table class="table table-striped table-bordered" id="fullDataTable">
            <thead>
              <tr>
                <th>Wavelength (nm)</th>
                <th>Intensity</th>
                <th>Timestamp</th>
              </tr>
            </thead>
            <tbody>
              {% for point in session.spectra.all %}
              <tr>
                <td>{{ point.wavelength|floatformat:2 }}</td>
                <td>{{ point.intensity|floatformat:4 }}</td>
                <td>{{ point.timestamp|date:"Y-m-d H:i:s" }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <button type="button" class="btn btn-primary" onclick="copyToClipboard('fullDataTable')">
          <i class="fas fa-copy me-1"></i>Copy to Clipboard
        </button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@1.2.1/dist/chartjs-plugin-zoom.min.js"></script>
<script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.11.5/js/dataTables.bootstrap5.min.js"></script>
<script>
// Initialize Chart
let spectralChart;
const ctx = document.getElementById('spectralChart').getContext('2d');

// Initialize chart with data
function initializeChart(labels, data) {
    if (spectralChart) {
        spectralChart.destroy();
    }
    
    spectralChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: 'Intensity',
                data: data,
                borderColor: '#4e73df',
                backgroundColor: 'rgba(78, 115, 223, 0.05)',
                borderWidth: 2,
                pointRadius: 2,
                pointBackgroundColor: '#4e73df',
                pointBorderColor: '#fff',
                pointHoverRadius: 4,
                fill: true,
                tension: 0.3
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false },
                tooltip: { 
                    mode: 'index', 
                    intersect: false,
                    callbacks: {
                        label: function(context) {
                            return `Wavelength: ${context.label} nm, Intensity: ${context.raw}`;
                        }
                    }
                },
                zoom: {
                    zoom: {
                        wheel: { enabled: true },
                        pinch: { enabled: true },
                        mode: 'xy',
                        speed: 0.5
                    },
                    pan: {
                        enabled: true,
                        mode: 'xy',
                        speed: 0.5
                    },
                    limits: {
                        x: { min: 'original', max: 'original' },
                        y: { min: 'original', max: 'original' }
                    }
                }
            },
            scales: {
                x: {
                    title: {
                        display: true,
                        text: 'Wavelength (nm)'
                    },
                    grid: {
                        display: false
                    }
                },
                y: {
                    title: {
                        display: true,
                        text: 'Intensity'
                    },
                    grid: {
                        color: 'rgba(0, 0, 0, 0.05)'
                    }
                }
            },
            interaction: {
                intersect: false,
                mode: 'nearest'
            }
        }
    });
}

// Load chart data from the server
function loadChartData() {
    fetch(`/sessions/{{ session.session_id }}/data/`)
        .then(response => response.json())
        .then(data => {
            const labels = data.map(point => parseFloat(point.wavelength).toFixed(2));
            const intensities = data.map(point => parseFloat(point.intensity));
            
            if (spectralChart) {
                spectralChart.data.labels = labels;
                spectralChart.data.datasets[0].data = intensities;
                spectralChart.update('none');
            } else {
                initializeChart(labels, intensities);
            }
            
            // Update data points count
            const dataPointsElement = document.querySelector('.data-points-count');
            if (dataPointsElement) {
                dataPointsElement.textContent = data.length;
            }
        })
        .catch(error => console.error('Error loading chart data:', error));
}

// Copy table data to clipboard
function copyToClipboard(elementId) {
    const el = document.createElement('textarea');
    const table = document.getElementById(elementId);
    
    // Get all rows
    const rows = table.querySelectorAll('tr');
    let csv = [];
    
    // Get headers
    const headers = [];
    table.querySelectorAll('th').forEach(header => {
        headers.push(header.textContent.trim());
    });
    csv.push(headers.join('\t'));
    
    // Get data rows
    rows.forEach(row => {
        const rowData = [];
        row.querySelectorAll('td').forEach(cell => {
            rowData.push(cell.textContent.trim());
        });
        if (rowData.length > 0) {
            csv.push(rowData.join('\t'));
        }
    });
    
    // Copy to clipboard
    el.value = csv.join('\n');
    document.body.appendChild(el);
    el.select();
    document.execCommand('copy');
    document.body.removeChild(el);
    
    // Show feedback
    const originalText = event.target.innerHTML;
    event.target.innerHTML = '<i class="fas fa-check"></i> Copied!';
    setTimeout(() => {
        event.target.innerHTML = originalText;
    }, 2000);
}

// WebSocket for real-time updates
const sessionId = '{{ session.session_id }}';
const wsScheme = window.location.protocol === 'https:' ? 'wss' : 'ws';
const wsPath = `${wsScheme}://${window.location.host}/ws/session/${sessionId}/`;
const socket = new WebSocket(wsPath);

// Function to update the status badge
function updateStatusBadge(status) {
    const badge = $('.status-badge');
    const icon = badge.find('i');
    
    // Remove all status classes
    badge.removeClass('bg-warning bg-success bg-danger')
          .removeClass('text-white')
          .addClass('text-white');
    
    // Set the appropriate status class and icon
    if (status === 'completed') {
        badge.addClass('bg-success');
        icon.removeClass().addClass('fas fa-check-circle me-1');
    } else if (status === 'failed') {
        badge.addClass('bg-danger');
        icon.removeClass().addClass('fas fa-times-circle me-1');
    } else {
        badge.addClass('bg-warning');
        icon.removeClass().addClass('fas fa-hourglass-half me-1');
    }
    
    // Update the status text
    badge.find('span:not(i)').text(status.charAt(0).toUpperCase() + status.slice(1).replace('_', ' '));
}

// Request status update every 2 seconds
setInterval(function() {
    if (socket.readyState === WebSocket.OPEN) {
        socket.send(JSON.stringify({message: 'update_status'}));
    }
}, 2000);

socket.onopen = function(e) {
    console.log('WebSocket connection established');
    // Request initial status update
    socket.send(JSON.stringify({message: 'update_status'}));
};

socket.onmessage = function(e) {
    const data = JSON.parse(e.data);
    
    if (data.type === 'status_update') {
        // Update the status badge
        updateStatusBadge(data.status);
        
        // If we have data but status is still in_progress, force a page reload
        if (data.has_data && data.status === 'in_progress') {
            setTimeout(function() {
                window.location.reload();
            }, 1000);
        }
    } else if (data.type === 'data_update') {
        // Update chart with new data
        loadChartData();
    }
};

socket.onclose = function() {
    console.log('WebSocket connection closed. Reconnecting...');
};

// Initialize everything when the page loads
$(document).ready(function() {
    // Initialize chart with data from the server
    {% if chart_data.has_data %}
    initializeChart({{ chart_data.wavelengths|safe }}, {{ chart_data.intensities|safe }});
    {% else %}
    // Show message if no data is available
    $('#spectralChart').html('<div class="text-center p-4"><i class="fas fa-chart-line fa-3x mb-2 text-muted"></i><p class="text-muted">No spectral data available yet. Data will appear here once available.</p></div>');
    {% endif %}
    
    // Initialize DataTable
    const dataTable = $('.data-table').DataTable({
        paging: true,
        lengthChange: true,
        searching: true,
        ordering: true,
        info: true,
        autoWidth: false,
        responsive: true,
        pageLength: 10,
        order: [[0, 'asc']],
        language: {
            search: 'Filter:',
            lengthMenu: 'Show _MENU_ entries',
            info: 'Showing _START_ to _END_ of _TOTAL_ entries',
            infoEmpty: 'No entries found',
            infoFiltered: '(filtered from _MAX_ total entries)',
            paginate: {
                first: 'First',
                last: 'Last',
                next: 'Next',
                previous: 'Previous'
            }
        },
        dom: '<"row"<"col-sm-12 col-md-6"l><"col-sm-12 col-md-6"f>>' +
             '<"row"<"col-sm-12"tr>>' +
             '<"row"<"col-sm-12 col-md-5"i><"col-sm-12 col-md-7"p>>'
    });
    
    // Initialize full screen DataTable in modal
    $('#dataModal').on('shown.bs.modal', function () {
        if (!$.fn.DataTable.isDataTable('#fullDataTable')) {
            $('#fullDataTable').DataTable({
                paging: true,
                lengthChange: true,
                searching: true,
                ordering: true,
                info: true,
                autoWidth: false,
                responsive: true,
                pageLength: 20,
                order: [[0, 'asc']],
                language: {
                    search: 'Filter:',
                    lengthMenu: 'Show _MENU_ entries',
                    info: 'Showing _START_ to _END_ of _TOTAL_ entries',
                    infoEmpty: 'No entries found',
                    infoFiltered: '(filtered from _MAX_ total entries)',
                    paginate: {
                        first: 'First',
                        last: 'Last',
                        next: 'Next',
                        previous: 'Previous'
                    }
                },
                dom: '<"row"<"col-sm-12 col-md-6"l><"col-sm-12 col-md-6"f>>' +
                     '<"row"<"col-sm-12"tr>>' +
                     '<"row"<"col-sm-12 col-md-5"i><"col-sm-12 col-md-7"p>>',
                scrollX: true,
                scrollY: '60vh',
                scrollCollapse: true
            });
        }
    });
    
    // Clean up DataTable when modal is closed
    $('#dataModal').on('hidden.bs.modal', function () {
        const table = $('#fullDataTable').DataTable();
        if (table) {
            table.destroy();
        }
    });

    // Initialize chart
    loadChartData();

    // Set up auto-refresh every 5 seconds
    const refreshInterval = setInterval(loadChartData, 5000);

    // Apply range filter
    $('#applyRange').on('click', function() {
        const min = parseFloat($('#minWavelength').val());
        const max = parseFloat($('#maxWavelength').val());
        
        if (!isNaN(min) && !isNaN(max) && min < max) {
            if (spectralChart) {
                spectralChart.options.scales.x.min = min;
                spectralChart.options.scales.x.max = max;
                spectralChart.update();
            }
        } else {
            alert('Please enter valid min and max wavelength values.');
        }
    });
    
    // Download chart as PNG
    $('#downloadPNG').on('click', function(e) {
        e.preventDefault();
        if (spectralChart) {
            const link = document.createElement('a');
            link.download = `spectrum_${sessionId}.png`;
            link.href = document.getElementById('spectralChart').toDataURL('image/png');
            link.click();
        }
    });
    
    // Reset zoom
    $('.reset-zoom').on('click', function() {
        if (spectralChart) {
            spectralChart.resetZoom();
        }
    });
    
    // Clean up on page unload
    $(window).on('beforeunload', function() {
        clearInterval(refreshInterval);
        if (socket) {
            socket.close();
        }
    });
});
</script>
{% endblock %}
